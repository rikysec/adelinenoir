<!DOCTYPE html>
<html lang="it" class="h-full bg-gray-100">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Adeline Chat</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://js.stripe.com/v3/"></script> <!-- SDK di Stripe -->
    <style>
        body { font-family: 'Inter', sans-serif; }
        .chat-bubble { max-width: 75%; }
        .chat-bubble-user { background-color: #3b82f6; color: white; }
        .chat-bubble-ai { background-color: #e5e7eb; color: #1f2937; }
        #chat-container { display: flex; flex-direction: column-reverse; overflow-y: auto; flex-grow: 1; }
        #payment-overlay { transition: opacity 0.3s ease-in-out; }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="h-full flex flex-col relative">

    <!-- Schermata di Pagamento (nascosta di default) -->
    <div id="payment-overlay" class="absolute inset-0 bg-gray-900 bg-opacity-80 flex items-center justify-center z-50 opacity-0 pointer-events-none">
        <div class="bg-white rounded-lg shadow-xl p-8 max-w-sm w-full text-center">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Chat Bloccata</h2>
            <p class="text-gray-600 mb-6">Per continuare la conversazione con Adeline, è richiesto un contributo di 4,99€.</p>
            <div id="payment-element" class="mb-6"></div>
            <button id="submit-payment" class="w-full bg-purple-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-purple-700 transition-colors disabled:bg-gray-400">
                <span id="button-text">Paga ora 4,99€</span>
                <span id="spinner" class="hidden">Elaborazione...</span>
            </button>
            <p id="payment-message" class="text-sm text-red-500 mt-4"></p>
        </div>
    </div>

    <!-- Contenuto principale della chat -->
    <div id="main-content" class="h-full flex flex-col">
        <header class="bg-white shadow-md p-4 flex items-center space-x-4 z-10">
            <div class="w-12 h-12 rounded-full bg-purple-500 flex items-center justify-center text-white text-xl font-bold">A</div>
            <div><h1 class="text-xl font-bold text-gray-800">Adeline</h1></div>
        </header>
        <main id="chat-container" class="p-4 space-y-4"></main>
        <div id="status-indicator" class="flex-grow flex items-center justify-center">
            <p id="status-text" class="text-gray-500 text-center p-4">Caricamento della chat...</p>
        </div>
        <div id="typing-indicator" class="p-4 hidden"><p class="text-gray-500 italic">Adeline sta scrivendo...</p></div>
        <footer class="bg-white p-4 border-t border-gray-200">
            <div class="flex items-center space-x-2">
                <input type="file" id="file-input" class="hidden" accept="image/*" onchange="uploadMedia()">
                <button onclick="document.getElementById('file-input').click()" class="p-3 rounded-full hover:bg-gray-200 transition-colors"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-600"><path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"></path></svg></button>
                <input type="text" id="message-input" placeholder="Scrivi un messaggio..." class="flex-grow p-3 border border-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-purple-500" onkeydown="handleKeyDown(event)">
                <button id="send-button" onclick="sendMessage()" class="p-3 rounded-full bg-purple-500 text-white hover:bg-purple-600 transition-colors"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-send-horizontal"><path d="m3 3 3 9-3 9 19-9Z"/><path d="M6 12h16"/></svg></button>
            </div>
            <div id="upload-progress" class="h-1 bg-purple-500 mt-2" style="width: 0%; transition: width 0.3s;"></div>
        </footer>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, updateDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-storage.js";

        const firebaseConfig = { apiKey: "AIzaSyAT1ahcUfjtwMiYkxUCsegcJha5-bqYQS0", authDomain: "adelinenoir-17242.firebaseapp.com", projectId: "adelinenoir-17242", storageBucket: "adelinenoir-17242.appspot.com", messagingSenderId: "422215885664", appId: "1:422215885664:web:be9f48bd7be6b6e5f7b405" };
        const GEMINI_API_KEY = "AIzaSyAkNETnuwhCKYjonnOH2busXoJw44uO0vg";
        const STRIPE_PUBLISHABLE_KEY = "pk_live_51S7jp1B75yXJ4j6QR9wfss6vBbUmrm5N97xejx0IY5sb7zuBlkOsd8Zoey1gkqMW2Wt1ZbR180OF5xhZJerOqVsT00winnXPdI"; 
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);
        const stripe = Stripe(STRIPE_PUBLISHABLE_KEY);

        const APP_ID = 'Richisec.AdelineNoirBot';
        let chatId = null;
        let unsubscribe = null;
        let isAiReplying = false;
        let conversationHistory = [];
        let elements, paymentIntentClientSecret;

        const ADELINE_PERSONA = `Sei Adeline...`;

        const typingIndicator = document.getElementById('typing-indicator');
        const paymentOverlay = document.getElementById('payment-overlay');
        const mainContent = document.getElementById('main-content');
        
        function showTyping() { typingIndicator.style.display = 'block'; }
        function hideTyping() { typingIndicator.style.display = 'none'; }
        
        async function handleLockState(isLocked) { /* ... codice invariato ... */ }
        function showStatus(message) { /* ... codice invariato ... */ }
        function hideStatus() { /* ... codice invariato ... */ }

        function renderMessages(messages) {
             const chatContainer = document.getElementById('chat-container');
            chatContainer.innerHTML = '';
            const sortedMessages = [...messages].sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
            conversationHistory = sortedMessages;

            sortedMessages.slice().reverse().forEach(msg => {
                const isUser = msg.sender === 'user';
                const bubble = document.createElement('div');
                bubble.className = `p-3 rounded-lg chat-bubble ${isUser ? 'chat-bubble-user self-end' : 'chat-bubble-ai self-start'}`;

                if (msg.type === 'text' && msg.text) {
                    const textNode = document.createElement('p');
                    textNode.textContent = msg.text;
                    bubble.appendChild(textNode);
                } else if (msg.type === 'image' && msg.mediaUrl) { // NUOVA LOGICA
                    const img = document.createElement('img');
                    img.src = msg.mediaUrl;
                    img.className = 'rounded-md max-w-full max-h-64';
                    img.onerror = () => img.alt = 'Immagine non caricata';
                    bubble.appendChild(img);
                }
                chatContainer.appendChild(bubble);
            });

            if (messages.length > 0) hideStatus();
            else showStatus("Ancora nessun messaggio. Scrivine uno per iniziare!");
        }
        
        // NUOVA FUNZIONE HELPER per convertire URL immagine in base64
        async function imageUrlToBase64(url) {
            // Usa un proxy per evitare problemi di CORS. `https://cors-anywhere.herokuapp.com/` è un proxy pubblico.
            // Per produzione, è consigliabile crearne uno proprio.
            const response = await fetch(`https://cors-anywhere.herokuapp.com/${url}`);
            const blob = await response.blob();
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onloadend = () => resolve(reader.result.split(',')[1]);
                reader.onerror = reject;
                reader.readAsDataURL(blob);
            });
        }

        async function getAdelineResponse(retries = 3, delay = 1000) {
            isAiReplying = true;
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${GEMINI_API_KEY}`;
            
            // NUOVA LOGICA PER GESTIRE IMMAGINI
            const contents = [];
            for (const msg of conversationHistory) {
                const role = msg.sender === 'user' ? 'user' : 'model';
                const parts = [];

                if (msg.text) {
                    parts.push({ text: msg.text });
                }

                if (msg.type === 'image' && msg.mediaUrl) {
                    try {
                        const base64Data = await imageUrlToBase64(msg.mediaUrl);
                        parts.push({
                            inline_data: {
                                mime_type: 'image/jpeg', // Assumiamo JPEG, si può rendere dinamico
                                data: base64Data
                            }
                        });
                    } catch (e) {
                        console.error("Errore nel convertire l'immagine in base64:", e);
                        parts.push({ text: "(Immagine non caricata)" });
                    }
                }
                 if(parts.length > 0) {
                    contents.push({ role, parts });
                }
            }

            try {
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents, systemInstruction: { parts: [{ text: ADELINE_PERSONA }] } }) });
                if (!response.ok) { throw new Error(`API error: ${response.status}`); }
                const result = await response.json();
                const adelineText = result.candidates?.[0]?.content?.parts?.[0]?.text || "Interessante...";
                const adelineMessage = { sender: "Adeline", text: adelineText, type: "text", mediaUrl: null, timestamp: new Date().toISOString() };
                const docRef = doc(db, "artifacts", APP_ID, "public", "data", "chats", chatId);
                await updateDoc(docRef, { messages: arrayUnion(adelineMessage) });
            } catch (error) {
                console.error("Errore chiamando Gemini:", error);
            } finally {
                isAiReplying = false;
            }
        }
        
        window.sendMessage = async function(mediaData = null) {
            const messageInput = document.getElementById('message-input');
            const text = messageInput.value.trim();
            if (!text && !mediaData) return;

            const newMessage = {
                sender: 'user',
                text: text, // Invia sempre il testo, anche con l'immagine
                type: mediaData ? mediaData.type : 'text',
                mediaUrl: mediaData ? mediaData.url : null,
                timestamp: new Date().toISOString()
            };
            
            const docRef = doc(db, "artifacts", APP_ID, "public", "data", "chats", chatId);
            await updateDoc(docRef, { messages: arrayUnion(newMessage) });
            
            messageInput.value = '';
        }

        window.uploadMedia = async function() {
            const fileInput = document.getElementById('file-input');
            const file = fileInput.files[0];
            if (!file) return;

            const mediaType = file.type.startsWith('image/') ? 'image' : 'video';
            if (mediaType !== 'image') {
                alert("Al momento sono supportate solo immagini.");
                return;
            }

            const storageRef = ref(storage, `chat_media/${chatId}/${new Date().getTime()}_${file.name}`);
            const uploadTask = uploadBytesResumable(storageRef, file);
            const progressBar = document.getElementById('upload-progress');

            uploadTask.on('state_changed', 
                (snapshot) => {
                    const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                    progressBar.style.width = progress + '%';
                }, 
                (error) => {
                    console.error("Errore di caricamento:", error);
                    progressBar.style.width = '0%';
                }, 
                () => {
                    getDownloadURL(uploadTask.snapshot.ref).then((downloadURL) => {
                        window.sendMessage({ type: 'image', url: downloadURL });
                        progressBar.style.width = '0%';
                    });
                }
            );
        }
        
        window.handleKeyDown = function(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }
        
        // --- LOGICA DI PAGAMENTO E INIZIALIZZAZIONE ---
        // (le funzioni initializePaymentForm, setLoading, checkPaymentStatus, main rimangono invariate)
        async function initializePaymentForm() { /* ... codice invariato ... */ }
        function setLoading(isLoading) { /* ... codice invariato ... */ }
        document.getElementById('submit-payment').addEventListener('click', async (e) => { /* ... codice invariato ... */ });
        async function checkPaymentStatus() { /* ... codice invariato ... */ }
        async function main() { /* ... codice invariato ... */ }
        document.addEventListener('DOMContentLoaded', main);
    </script>
</body>
</html>

